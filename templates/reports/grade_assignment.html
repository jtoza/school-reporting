{% extends 'base.html' %}

{% block title %}Grade Assignment - School Reporting System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Grade Assignment
                </h4>
            </div>
            <div class="card-body">
                <!-- Submission Info -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ submission.assignment.title }}</h5>
                        <p class="card-text">
                            <strong>Student:</strong> {{ submission.student.full_name }}<br>
                            <strong>Subject:</strong> {{ submission.assignment.subject.name }}<br>
                            <strong>Submitted:</strong> {{ submission.submitted_at|date:"M d, Y H:i" }}<br>
                            <strong>Max Points:</strong> {{ submission.assignment.max_points }}
                        </p>
                        
                        {% if submission.submitted_file %}
                        <div class="mt-3">
                            <strong>Submitted File:</strong>
                            <div class="mt-2">
                                <a href="{{ submission.submitted_file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-download me-2"></i>Download Submission
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if submission.submission_text %}
                        <div class="mt-3">
                            <strong>Text Submission:</strong>
                            <div class="p-3 bg-light rounded mt-2">
                                {{ submission.submission_text|linebreaks }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Grading Form -->
                <form method="post">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.grade.id_for_label }}" class="form-label">Grade</label>
                            <input type="number" name="grade" class="form-control" id="{{ form.grade.id_for_label }}" 
                                   value="{{ form.grade.value|default:'' }}" min="0" max="{{ submission.assignment.max_points }}" 
                                   step="0.5" placeholder="Enter grade out of {{ submission.assignment.max_points }}">
                            {% if form.grade.errors %}
                            <div class="text-danger small">{{ form.grade.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                Enter a grade between 0 and {{ submission.assignment.max_points }}
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="is_graded" 
                                       id="{{ form.is_graded.id_for_label }}" 
                                       {% if form.is_graded.value %}checked{% endif %}>
                                <label class="form-check-label" for="{{ form.is_graded.id_for_label }}">
                                    Mark as Graded
                                </label>
                            </div>
                            <div class="form-text">
                                Check this box when you're finished grading
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.teacher_feedback.id_for_label }}" class="form-label">Teacher Feedback</label>
                        <textarea name="teacher_feedback" class="form-control" id="{{ form.teacher_feedback.id_for_label }}" 
                                  rows="4" placeholder="Provide constructive feedback for the student...">{{ form.teacher_feedback.value|default:'' }}</textarea>
                        {% if form.teacher_feedback.errors %}
                        <div class="text-danger small">{{ form.teacher_feedback.errors }}</div>
                        {% endif %}
                        <div class="form-text">
                            This feedback will be visible to the student and parent
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'reports:assignment_detail' submission.assignment.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Assignment
                        </a>
                        <div>
                            <button type="submit" name="save_draft" class="btn btn-outline-primary">
                                <i class="fas fa-save me-2"></i>Save Draft
                            </button>
                            <button type="submit" name="save_final" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Save & Mark Graded
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-check "Mark as Graded" when grade is entered
        const gradeInput = document.getElementById('{{ form.grade.id_for_label }}');
        const gradedCheckbox = document.getElementById('{{ form.is_graded.id_for_label }}');
        
        if (gradeInput && gradedCheckbox) {
            gradeInput.addEventListener('input', function() {
                if (this.value && this.value > 0) {
                    gradedCheckbox.checked = true;
                }
            });
        }
        
        // Handle different submit buttons
        const saveDraftBtn = document.querySelector('button[name="save_draft"]');
        const saveFinalBtn = document.querySelector('button[name="save_final"]');
        
        if (saveFinalBtn) {
            saveFinalBtn.addEventListener('click', function() {
                document.getElementById('{{ form.is_graded.id_for_label }}').checked = true;
            });
        }
    });
</script>
{% endblock %}
{% endblock %}